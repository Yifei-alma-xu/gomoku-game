<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹æ¸¸æˆ</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --dark-color: #2d3142;
            --light-color: #f5f5f5;
            --board-color: #dcb35c;
            --board-border: #8b4513;
            --black-stone: radial-gradient(circle at 30% 30%, #666, #000);
            --white-stone: radial-gradient(circle at 30% 30%, #fff, #ddd);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--light-color);
            color: var(--dark-color);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: var(--secondary-color);
            margin: 15px 0;
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .menu-container,
        .game-container {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            width: 100%;
            transition: var(--transition);
        }

        .game-container {
            display: none;
        }

        .menu-title,
        .settings-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-color);
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }

        .option-button {
            padding: 12px 20px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background-color: white;
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .option-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .option-button.selected {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2);
        }

        .start-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .start-button:active {
            transform: translateY(0);
        }

        /* åœ¨çº¿å¯¹æˆ˜çŠ¶æ€æç¤º */
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        /* æ¸¸æˆæ¨¡å¼æ ‡ç­¾ */
        .mode-tag {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* è¿æ¥çŠ¶æ€åŠ¨ç”» */
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .connection-status.connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        /* æ£‹ç›˜æ ·å¼ */
        #board {
            background-color: var(--board-color);
            display: grid;
            grid-template-columns: repeat(15, 30px);
            grid-template-rows: repeat(15, 30px);
            gap: 1px;
            padding: 15px;
            border: 3px solid var(--board-border);
            border-radius: 5px;
            box-shadow: var(--shadow);
            margin: 0 auto;
        }

        .cell {
            width: 30px;
            height: 30px;
            background-color: rgba(220, 179, 92, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .cell:hover {
            background-color: rgba(210, 169, 82, 0.9);
            transform: scale(1.05);
        }

        .cell::before,
        .cell::after {
            content: '';
            position: absolute;
            background-color: #000;
        }

        .cell::before {
            width: 100%;
            height: 1px;
            top: 50%;
            transform: translateY(-50%);
        }

        .cell::after {
            width: 1px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .stone {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            z-index: 1;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
        }

        .black {
            background: var(--black-stone);
        }

        .white {
            background: var(--white-stone);
        }

        /* æ¸¸æˆä¿¡æ¯åŒºåŸŸ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            border-radius: 25px;
            transition: var(--transition);
        }

        .player-info.active {
            background-color: rgba(79, 195, 247, 0.2);
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .player-info.active .player-avatar {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .player-avatar {
            font-size: 1.8rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 50%;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player-role {
            font-size: 0.9rem;
            color: #666;
        }

        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .timer-label {
            font-size: 0.9rem;
            color: #666;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            min-width: 50px;
            text-align: center;
        }

        /* æ¸¸æˆæ¶ˆæ¯ */
        .game-message {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: 8px;
            transition: var(--transition);
        }

        .game-message.winner {
            background-color: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
            font-size: 1.3rem;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .game-over-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
        }

        .game-over-options button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .game-over-options .rematch-btn {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
        }

        .game-over-options .menu-btn {
            background: linear-gradient(to right, #78909c, #607d8b);
            color: white;
        }

        .game-over-options button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .game-over-options button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .game-over-options .waiting {
            position: relative;
        }

        .game-over-options .waiting::after {
            content: 'ç­‰å¾…å¯¹æ–¹ç¡®è®¤...';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
        }

        /* è®¾ç½®è¾“å…¥ */
        .settings-group {
            margin-bottom: 20px;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .input-row label {
            min-width: 120px;
            font-weight: 500;
            color: #555;
        }

        .input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-row input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
        }

        /* å¤´åƒé€‰æ‹© */
        .avatar-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .avatar-option {
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 50%;
            padding: 5px;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            background-color: rgba(79, 195, 247, 0.3);
        }

        .avatar-option.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            #board {
                grid-template-columns: repeat(15, 20px);
                grid-template-rows: repeat(15, 20px);
                padding: 10px;
            }

            .cell {
                width: 20px;
                height: 20px;
            }

            .stone {
                width: 18px;
                height: 18px;
            }

            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .player-info {
                width: 100%;
                justify-content: center;
            }

            .option-group {
                flex-direction: column;
            }

            .option-button {
                width: 100%;
            }
        }

        /* æ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-dots {
            display: inline-block;
        }
        .loading-dots span {
            animation: dots 1.5s infinite;
            font-size: 20px;
            margin: 0 2px;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.5s; }
        .loading-dots span:nth-child(3) { animation-delay: 1s; }
        @keyframes dots {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            80%, 100% { opacity: 0; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .game-message.winner {
            animation: slideIn 0.5s ease-out;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.2), rgba(105, 240, 174, 0.2));
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* æ·»åŠ æˆ¿é—´çŠ¶æ€æ ·å¼ */
        .room-status {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .room-status .status-header {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .room-status .room-id {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.95rem;
            color: #166088;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
        }

        .room-status .room-id .copy-btn {
            background: none;
            border: none;
            color: #4a6fa5;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .room-status .room-id .copy-btn:hover {
            background: rgba(74, 111, 165, 0.1);
        }

        .room-status .status-message {
            font-size: 0.9rem;
            color: #495057;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-status .loading-dots {
            margin-left: 4px;
        }

        .room-status .loading-dots span {
            font-size: 16px;
        }

        .room-status.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .room-status.error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        .room-status.waiting {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ·»åŠ æ¸¸æˆåŒºåŸŸå¸ƒå±€æ ·å¼ */
        .game-area {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin: 20px 0;
        }

        .game-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 200px;
        }

        .sidebar-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .sidebar-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sidebar-button.undo {
            background: linear-gradient(to right, #ff9800, #f57c00);
        }

        .sidebar-button.rematch {
            background: linear-gradient(to right, #4CAF50, #45a049);
        }

        .sidebar-button.menu {
            background: linear-gradient(to right, #78909c, #607d8b);
        }

        .sidebar-button.waiting {
            position: relative;
        }

        .sidebar-button.waiting::after {
            content: 'ç­‰å¾…å¯¹æ–¹ç¡®è®¤...';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
        }

        /* ä¿®æ”¹æ¸¸æˆæ¶ˆæ¯æ ·å¼ä½ç½® */
        .game-message {
            margin: 15px 0;
        }

        /* ä¿®æ”¹è®¡æ—¶å™¨å®¹å™¨æ ·å¼ */
        .timer-container {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        /* æ·»åŠ æˆ¿é—´IDè¾“å…¥åŒºåŸŸæ ·å¼ */
        .room-id-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .room-id-input-area input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .room-id-input-area input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
        }

        .room-id-input-area .confirm-join {
            padding: 10px 20px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .room-id-input-area .confirm-join:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .room-id-input-area .confirm-join:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>äº”å­æ£‹æ¸¸æˆ</h1>

        <!-- ä¸»èœå• -->
        <div class="menu-container" id="menu-container">
            <h2 class="menu-title">æ¸¸æˆè®¾ç½®</h2>

            <!-- åŸæ¨¡å¼é€‰æ‹©éƒ¨åˆ†ä¿®æ”¹ä¸º -->
            <div class="section">
                <h3 class="section-title">æ¸¸æˆæ¨¡å¼</h3>
                <div class="option-group">
                    <button class="option-button" data-mode="pvp">åŒäººå¯¹æˆ˜</button>
                    <button class="option-button" data-mode="pvc">äººæœºå¯¹æˆ˜</button>
                    <button class="option-button" data-mode="online">åœ¨çº¿å¯¹æˆ˜</button>
                </div>
            </div>


            <div class="section" id="difficulty-section" style="display: none;">
                <h3 class="section-title">ç”µè„‘éš¾åº¦</h3>
                <div class="option-group">
                    <button class="option-button" data-difficulty="easy">ç®€å•</button>
                    <button class="option-button" data-difficulty="medium">ä¸­ç­‰</button>
                    <button class="option-button" data-difficulty="hard">å›°éš¾</button>
                </div>
            </div>


            <div class="section">
                <h3 class="section-title">ç©å®¶è®¾ç½®</h3>
                <div class="settings-group">
                    <div class="input-row">
                        <label for="player1-name">ç©å®¶1åç§°:</label>
                        <input type="text" id="player1-name" placeholder="ç©å®¶1" maxlength="10">
                    </div>
                    <div class="input-row">
                        <label>ç©å®¶1å¤´åƒ:</label>
                        <div class="player-avatar" id="player1-avatar-preview">ğŸ±</div>
                    </div>
                    <div class="avatar-selection" id="player1-avatar-options">
                        <div class="avatar-option" data-avatar="ğŸµ">ğŸµ</div>
                        <div class="avatar-option" data-avatar="ğŸ¶">ğŸ¶</div>
                        <div class="avatar-option" data-avatar="ğŸ±">ğŸ±</div>
                        <div class="avatar-option" data-avatar="ğŸ­">ğŸ­</div>
                        <div class="avatar-option" data-avatar="ğŸ¹">ğŸ¹</div>
                        <div class="avatar-option" data-avatar="ğŸ°">ğŸ°</div>
                        <div class="avatar-option" data-avatar="ğŸ¦Š">ğŸ¦Š</div>
                        <div class="avatar-option" data-avatar="ğŸ»">ğŸ»</div>
                        <div class="avatar-option" data-avatar="ğŸ¼">ğŸ¼</div>
                        <div class="avatar-option" data-avatar="ğŸ¨">ğŸ¨</div>
                        <div class="avatar-option" data-avatar="ğŸ¯">ğŸ¯</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                    </div>
                </div>

                <div class="settings-group" id="player2-settings">
                    <div class="input-row">
                        <label for="player2-name">ç©å®¶2åç§°:</label>
                        <input type="text" id="player2-name" placeholder="ç©å®¶2" maxlength="10">
                    </div>
                    <div class="input-row">
                        <label>ç©å®¶2å¤´åƒ:</label>
                        <div class="player-avatar" id="player2-avatar-preview">ğŸ¶</div>
                    </div>
                    <div class="avatar-selection" id="player2-avatar-options">
                        <div class="avatar-option" data-avatar="ğŸ®">ğŸ®</div>
                        <div class="avatar-option" data-avatar="ğŸ·">ğŸ·</div>
                        <div class="avatar-option" data-avatar="ğŸ¸">ğŸ¸</div>
                        <div class="avatar-option" data-avatar="ğŸ™">ğŸ™</div>
                        <div class="avatar-option" data-avatar="ğŸ¦„">ğŸ¦„</div>
                        <div class="avatar-option" data-avatar="ğŸ²">ğŸ²</div>
                        <div class="avatar-option" data-avatar="ğŸ´">ğŸ´</div>
                        <div class="avatar-option" data-avatar="ğŸ¦“">ğŸ¦“</div>
                        <div class="avatar-option" data-avatar="ğŸ¦’">ğŸ¦’</div>
                        <div class="avatar-option" data-avatar="ğŸ˜">ğŸ˜</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">æ¸¸æˆè®¾ç½®</h3>
                <div class="settings-group">
                    <div class="input-row">
                        <label for="time-limit">è½å­æ—¶é—´é™åˆ¶(ç§’):</label>
                        <input type="number" id="time-limit" min="10" max="300" value="60">
                    </div>
                </div>
            </div>

            <!-- ä¿®æ”¹åœ¨çº¿å¯¹æˆ˜è®¾ç½®é¢æ¿ -->
            <div class="section" id="online-section" style="display: none;">
                <h3 class="section-title">åœ¨çº¿å¯¹æˆ˜è®¾ç½®</h3>
                <div class="option-group">
                    <button class="option-button" id="create-room-btn">åˆ›å»ºæˆ¿é—´</button>
                    <button class="option-button" id="join-room-btn">åŠ å…¥æˆ¿é—´</button>
                </div>
                <div id="room-id-input" style="display: none;">
                    <div class="room-id-input-area">
                        <input type="text" id="room-id" placeholder="è¾“å…¥å¯¹æ–¹æˆ¿é—´ID">
                        <button class="confirm-join" id="confirm-join-btn">
                            <i class="fas fa-sign-in-alt"></i> åŠ å…¥
                        </button>
                    </div>
                </div>
                <div id="room-status" class="game-message" style="margin-top: 10px;"></div>
            </div>

            <button class="start-button" id="start-button">
                <i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ
            </button>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="game-container" id="game-container">
            <div class="game-header">
                <div class="player-info" id="black-player-info">
                    <div class="player-avatar" id="black-avatar"></div>
                    <div>
                        <div class="player-name" id="black-name">ç©å®¶1</div>
                        <div class="player-role">é»‘æ£‹</div>
                    </div>
                </div>

                <div class="timer-container">
                    <div class="timer-label">å‰©ä½™æ—¶é—´</div>
                    <div class="timer" id="timer">60</div>
                </div>

                <div class="player-info" id="white-player-info">
                    <div class="player-avatar" id="white-avatar"></div>
                    <div>
                        <div class="player-name" id="white-name">ç©å®¶2</div>
                        <div class="player-role">ç™½æ£‹</div>
                    </div>
                </div>
            </div>

            <div class="game-area">
                <div id="board"></div>
                <div class="game-sidebar">
                    <button class="sidebar-button undo" onclick="handleUndo()" id="undo-button">
                        <i class="fas fa-undo"></i> æ‚”æ£‹
                    </button>
                    <button class="sidebar-button rematch" onclick="handleRematch()" id="rematch-button">
                        <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                    </button>
                    <button class="sidebar-button menu" onclick="handleReturnToMenu()" id="menu-button">
                        <i class="fas fa-home"></i> è¿”å›èœå•
                    </button>
                </div>
            </div>

            <div class="game-message" id="game-message"></div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            mode: null, // 'pvp' | 'pvc' | 'online'
            difficulty: 'medium', // 'easy', 'medium', 'hard'
            timeLimit: 60, // é»˜è®¤60ç§’
            board: Array(15).fill().map(() => Array(15).fill(null)), // 15x15æ£‹ç›˜
            currentPlayer: 'black', // 'black' æˆ– 'white'
            gameOver: false,
            timer: null,
            timeLeft: 60,
            lastMove: null,
            player1Name: 'ç©å®¶1',
            player1Avatar: 'ğŸ±',
            player2Name: 'ç©å®¶2',
            player2Avatar: 'ğŸ¶',
            computerAvatar: 'ğŸ¤–',
            moveHistory: [], // è®°å½•æ¯æ­¥æ£‹çš„å†å²
            canUndo: true, // æ˜¯å¦å¯ä»¥æ‚”æ£‹
            online: {
                peer: null,
                conn: null,
                isHost: false,
                roomId: '',
                playerName: '',
                opponentName: 'å¯¹æ‰‹',
                playerAvatar: '',
                opponentAvatar: ''
            }
        };

        // DOMå…ƒç´ 
        const menuContainer = document.getElementById('menu-container');
        const gameContainer = document.getElementById('game-container');
        const boardElement = document.getElementById('board');
        const timerElement = document.getElementById('timer');
        const gameMessageElement = document.getElementById('game-message');
        const blackPlayerInfo = document.getElementById('black-player-info');
        const whitePlayerInfo = document.getElementById('white-player-info');
        const blackNameElement = document.getElementById('black-name');
        const whiteNameElement = document.getElementById('white-name');
        const blackAvatarElement = document.getElementById('black-avatar');
        const whiteAvatarElement = document.getElementById('white-avatar');
        const difficultySection = document.getElementById('difficulty-section');
        const player2Settings = document.getElementById('player2-settings');
        const timeLimitInput = document.getElementById('time-limit');
        const startButton = document.getElementById('start-button');
        const backButton = document.getElementById('back-button');
        const restartButton = document.getElementById('restart-button');

        // ç©å®¶è®¾ç½®å…ƒç´ 
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1AvatarPreview = document.getElementById('player1-avatar-preview');
        const player2AvatarPreview = document.getElementById('player2-avatar-preview');
        const player1AvatarOptions = document.querySelectorAll('#player1-avatar-options .avatar-option');
        const player2AvatarOptions = document.querySelectorAll('#player2-avatar-options .avatar-option');

        // åˆå§‹åŒ–å¤´åƒé€‰æ‹©
        player1AvatarOptions.forEach(option => {
            option.addEventListener('click', () => {
                gameState.player1Avatar = option.dataset.avatar;
                player1AvatarPreview.textContent = gameState.player1Avatar;
                player1AvatarOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        player2AvatarOptions.forEach(option => {
            option.addEventListener('click', () => {
                gameState.player2Avatar = option.dataset.avatar;
                player2AvatarPreview.textContent = gameState.player2Avatar;
                player2AvatarOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        // éšæœºé€‰æ‹©åˆå§‹å¤´åƒ
        function selectRandomAvatar() {
            const randomIndex1 = Math.floor(Math.random() * player1AvatarOptions.length);
            const randomIndex2 = Math.floor(Math.random() * player2AvatarOptions.length);

            player1AvatarOptions[randomIndex1].click();
            player2AvatarOptions[randomIndex2].click();
        }

        // æ¨¡å¼é€‰æ‹© - ä¿®æ”¹åçš„ä»£ç 
        document.querySelectorAll('.option-group button[data-mode]').forEach(button => {
            button.addEventListener('click', function () {
                // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.option-group button[data-mode]').forEach(btn => {
                    btn.classList.remove('selected');
                });

                // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                this.classList.add('selected');
                gameState.mode = this.dataset.mode;

                // æ˜¾ç¤ºå¯¹åº”è®¾ç½®é¢æ¿
                difficultySection.style.display = gameState.mode === 'pvc' ? 'block' : 'none';
                player2Settings.style.display = gameState.mode === 'pvp' ? 'block' : 'none';
                document.getElementById('online-section').style.display =
                    gameState.mode === 'online' ? 'block' : 'none';
            });
        });

        // éš¾åº¦é€‰æ‹©
        document.querySelectorAll('#difficulty-section .option-button').forEach(button => {
            button.addEventListener('click', function () {
                document.querySelectorAll('#difficulty-section .option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                this.classList.add('selected');
                gameState.difficulty = this.dataset.difficulty;
            });
        });

        // ä¿®æ”¹åˆ›å»ºæˆ¿é—´çš„ä»£ç 
        document.getElementById('create-room-btn').addEventListener('click', () => {
            gameState.online.playerName = document.getElementById('player1-name').value || 'ç©å®¶1';
            gameState.online.playerAvatar = gameState.player1Avatar;
            gameState.online.isHost = true;

            const roomStatus = document.getElementById('room-status');
            roomStatus.className = 'room-status waiting';
            roomStatus.innerHTML = `
                <div class="status-header">åˆ›å»ºæˆ¿é—´ä¸­...</div>
                <div class="status-message">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    æ­£åœ¨åˆå§‹åŒ–è¿æ¥
                </div>
            `;

            gameState.online.peer = new Peer();
            gameState.online.peer.on('open', (id) => {
                gameState.online.roomId = id;
                roomStatus.innerHTML = `
                    <div class="status-header">æˆ¿é—´åˆ›å»ºæˆåŠŸ</div>
                    <div class="room-id">
                        <span>${id}</span>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${id}')">
                            <i class="fas fa-copy"></i> å¤åˆ¶
                        </button>
                    </div>
                    <div class="status-message">
                        <i class="fas fa-user-clock"></i>
                        ç­‰å¾…å¯¹æ‰‹åŠ å…¥ä¸­
                        <div class="loading-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>
                `;
                document.getElementById('create-room-btn').disabled = true;
            });

            gameState.online.peer.on('connection', (conn) => {
                gameState.online.conn = conn;
                roomStatus.className = 'room-status success';
                roomStatus.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-check-circle"></i>
                        å¯¹æ‰‹å·²åŠ å…¥æˆ¿é—´ï¼æ­£åœ¨è¿›å…¥æ¸¸æˆ...
                    </div>
                `;
                
                setTimeout(() => {
                    setupConnection();
                    startButton.click();
                }, 2000);
            });

            gameState.online.peer.on('error', (err) => {
                roomStatus.className = 'room-status error';
                roomStatus.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-exclamation-circle"></i>
                        åˆ›å»ºæˆ¿é—´å¤±è´¥: ${err.message}
                    </div>
                `;
                document.getElementById('create-room-btn').disabled = false;
            });
        });

        // ä¿®æ”¹åŠ å…¥æˆ¿é—´çš„ä»£ç 
        document.getElementById('join-room-btn').addEventListener('click', () => {
            const roomIdInput = document.getElementById('room-id-input');
            roomIdInput.style.display = 'block';
            
            const joinRoom = () => {
                const roomId = document.getElementById('room-id').value.trim();
                if (!roomId) {
                    const roomStatus = document.getElementById('room-status');
                    roomStatus.className = 'room-status error';
                    roomStatus.innerHTML = `
                        <div class="status-message">
                            <i class="fas fa-exclamation-circle"></i>
                            è¯·è¾“å…¥æˆ¿é—´ID
                        </div>
                    `;
                    return;
                }

                gameState.online.playerName = document.getElementById('player2-name').value || 'ç©å®¶2';
                gameState.online.playerAvatar = gameState.player2Avatar;
                
                const roomStatus = document.getElementById('room-status');
                roomStatus.className = 'room-status waiting';
                roomStatus.innerHTML = `
                    <div class="status-header">åŠ å…¥æˆ¿é—´ä¸­...</div>
                    <div class="status-message">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        æ­£åœ¨è¿æ¥
                        <div class="loading-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>
                `;

                // ç¦ç”¨åŠ å…¥æŒ‰é’®
                document.getElementById('confirm-join-btn').disabled = true;

                gameState.online.peer = new Peer();
                gameState.online.peer.on('open', () => {
                    try {
                        gameState.online.conn = gameState.online.peer.connect(roomId);
                        gameState.online.conn.on('open', () => {
                            roomStatus.className = 'room-status success';
                            roomStatus.innerHTML = `
                                <div class="status-message">
                                    <i class="fas fa-check-circle"></i>
                                    è¿æ¥æˆåŠŸï¼æ­£åœ¨è¿›å…¥æ¸¸æˆ...
                                </div>
                            `;
                            
                            setTimeout(() => {
                                setupConnection();
                                startButton.click();
                            }, 2000);
                        });
                    } catch (err) {
                        roomStatus.className = 'room-status error';
                        roomStatus.innerHTML = `
                            <div class="status-message">
                                <i class="fas fa-exclamation-circle"></i>
                                è¿æ¥å¤±è´¥: ${err.message}
                            </div>
                        `;
                        // é‡æ–°å¯ç”¨åŠ å…¥æŒ‰é’®
                        document.getElementById('confirm-join-btn').disabled = false;
                    }
                });

                gameState.online.peer.on('error', (err) => {
                    roomStatus.className = 'room-status error';
                    roomStatus.innerHTML = `
                        <div class="status-message">
                            <i class="fas fa-exclamation-circle"></i>
                            è¿æ¥å¤±è´¥: ${err.message}
                        </div>
                    `;
                    // é‡æ–°å¯ç”¨åŠ å…¥æŒ‰é’®
                    document.getElementById('confirm-join-btn').disabled = false;
                });
            };

            // ä¸ºç¡®è®¤åŠ å…¥æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('confirm-join-btn').onclick = joinRoom;
            
            // ä¿ç•™å›è½¦é”®åŠŸèƒ½
            document.getElementById('room-id').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinRoom();
                }
            });
        });

        function setupConnection() {
            const conn = gameState.online.conn;

            conn.on('open', () => {
                // äº¤æ¢ç©å®¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°å’Œå¤´åƒ
                conn.send({ 
                    type: 'handshake', 
                    name: gameState.online.playerName,
                    avatar: gameState.online.playerAvatar
                });

                // æ›´æ–°UI
                document.getElementById('online-section').style.display = 'none';
                document.getElementById('room-status').textContent = '';

                // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                const statusEl = document.createElement('div');
                statusEl.className = 'connection-status connected';
                statusEl.textContent = `å·²è¿æ¥: ${gameState.online.opponentName}`;
                document.body.appendChild(statusEl);

                // æ˜¾ç¤ºæ¸¸æˆæ¨¡å¼æ ‡ç­¾
                const modeTag = document.createElement('div');
                modeTag.className = 'mode-tag';
                modeTag.textContent = 'åœ¨çº¿å¯¹æˆ˜';
                document.body.appendChild(modeTag);

                // åˆå§‹åŒ–æ¸¸æˆ
                initializeGame();
            });

            conn.on('data', (data) => {
                if (data.type === 'handshake') {
                    gameState.online.opponentName = data.name;
                    gameState.online.opponentAvatar = data.avatar;
                    updatePlayerInfo();
                } else if (data.type === 'move') {
                    placeStone(data.row, data.col, data.player);
                    switchPlayer();
                } else if (data.type === 'game_over') {
                    if (data.result === 'draw') {
                        gameOver('å¹³å±€!');
                    } else {
                        const winnerName = data.winnerName;
                        gameOver(`${winnerName} è·èƒœ!`);
                    }
                } else if (data.type === 'rematch_request') {
                    handleRematchRequest();
                } else if (data.type === 'rematch_accept') {
                    startNewGame();
                    showMessage('å¯¹æ–¹åŒæ„äº†é‡æ–°å¼€å§‹çš„è¯·æ±‚');
                } else if (data.type === 'rematch_decline') {
                    showMessage('å¯¹æ–¹æ‹’ç»äº†é‡æ–°å¼€å§‹çš„è¯·æ±‚');
                    enableRematchButton();
                } else if (data.type === 'return_to_menu') {
                    cleanupOnlineConnection();
                    menuContainer.style.display = 'block';
                    gameContainer.style.display = 'none';
                } else if (data.type === 'undo_request') {
                    handleUndoRequest();
                } else if (data.type === 'undo_accept') {
                    performUndo();
                    enableUndoButton();
                    showMessage('å¯¹æ–¹åŒæ„äº†æ‚”æ£‹è¯·æ±‚');
                } else if (data.type === 'undo_decline') {
                    showMessage('å¯¹æ–¹æ‹’ç»äº†æ‚”æ£‹è¯·æ±‚');
                    enableUndoButton();
                }
            });

            conn.on('close', () => {
                alert('è¿æ¥å·²æ–­å¼€');
                cleanupOnlineConnection();
                menuContainer.style.display = 'block';
                gameContainer.style.display = 'none';
            });
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯æ˜¾ç¤º
        function updatePlayerInfo() {
            if (gameState.mode === 'online') {
                if (gameState.online.isHost) {
                    blackNameElement.textContent = gameState.online.playerName;
                    blackAvatarElement.textContent = gameState.online.playerAvatar;
                    whiteNameElement.textContent = gameState.online.opponentName;
                    whiteAvatarElement.textContent = gameState.online.opponentAvatar;
                } else {
                    blackNameElement.textContent = gameState.online.opponentName;
                    blackAvatarElement.textContent = gameState.online.opponentAvatar;
                    whiteNameElement.textContent = gameState.online.playerName;
                    whiteAvatarElement.textContent = gameState.online.playerAvatar;
                }
            }
        }

        // å¼€å§‹æ¸¸æˆ
        startButton.addEventListener('click', () => {
            if (!gameState.mode) {
                showMessage('è¯·é€‰æ‹©æ¸¸æˆæ¨¡å¼');
                return;
            }

            // è·å–ç©å®¶åç§°
            gameState.player1Name = player1NameInput.value.trim() || 'ç©å®¶1';
            if (gameState.mode === 'pvp') {
                gameState.player2Name = player2NameInput.value.trim() || 'ç©å®¶2';
            } else {
                gameState.player2Name = 'ç”µè„‘';
            }

            // è·å–æ—¶é—´é™åˆ¶
            gameState.timeLimit = parseInt(timeLimitInput.value) || 60;
            if (gameState.timeLimit < 10 || gameState.timeLimit > 300) {
                showMessage('æ—¶é—´é™åˆ¶å¿…é¡»åœ¨10-300ç§’ä¹‹é—´', 'error');
                return;
            }

            initializeGame();
            menuContainer.style.display = 'none';
            gameContainer.style.display = 'block';
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            gameMessageElement.textContent = message;
            gameMessageElement.className = 'game-message';
            if (type === 'error') {
                gameMessageElement.style.color = '#d32f2f';
            } else if (type === 'winner') {
                gameMessageElement.classList.add('winner');
            }
        }

        // è¿”å›èœå•
        backButton.addEventListener('click', () => {
            if (gameState.mode === 'online' && gameState.online.conn) {
                // å‘é€æ–­å¼€è¿æ¥æ¶ˆæ¯ç»™å¯¹æ–¹
                try {
                    gameState.online.conn.send({ type: 'disconnect' });
                    cleanupOnlineConnection();
                } catch (e) {
                    console.error('æ–­å¼€è¿æ¥æ—¶å‡ºé”™:', e);
                }
            }
            clearInterval(gameState.timer);
            menuContainer.style.display = 'block';
            gameContainer.style.display = 'none';
            
            // æ¸…ç†åœ¨çº¿å¯¹æˆ˜ç›¸å…³çš„UIå…ƒç´ 
            const statusEl = document.querySelector('.connection-status');
            const modeTag = document.querySelector('.mode-tag');
            if (statusEl) statusEl.remove();
            if (modeTag) modeTag.remove();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGameState();
        });

        // æ¸…ç†åœ¨çº¿è¿æ¥
        function cleanupOnlineConnection() {
            if (gameState.online.conn) {
                gameState.online.conn.close();
            }
            if (gameState.online.peer) {
                gameState.online.peer.destroy();
            }
            // é‡ç½®åœ¨çº¿å¯¹æˆ˜çŠ¶æ€
            gameState.online = {
                peer: null,
                conn: null,
                isHost: false,
                roomId: '',
                playerName: '',
                opponentName: 'å¯¹æ‰‹',
                playerAvatar: '',
                opponentAvatar: ''
            };
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            const createRoomBtn = document.getElementById('create-room-btn');
            const joinRoomBtn = document.getElementById('join-room-btn');
            if (createRoomBtn) createRoomBtn.disabled = false;
            if (joinRoomBtn) joinRoomBtn.disabled = false;
            
            // éšè—æˆ¿é—´IDè¾“å…¥æ¡†
            const roomIdInput = document.getElementById('room-id-input');
            if (roomIdInput) roomIdInput.style.display = 'none';
            
            // æ¸…ç©ºæˆ¿é—´çŠ¶æ€ä¿¡æ¯
            const roomStatus = document.getElementById('room-status');
            if (roomStatus) roomStatus.textContent = '';
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGameState() {
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.gameOver = false;
            gameState.lastMove = null;
            gameState.timeLeft = gameState.timeLimit;
            gameState.moveHistory = [];
            gameState.mode = null;
            gameState.difficulty = 'medium';
            
            // é‡ç½®åœ¨çº¿å¯¹æˆ˜çŠ¶æ€
            gameState.online = {
                peer: null,
                conn: null,
                isHost: false,
                roomId: '',
                playerName: '',
                opponentName: 'å¯¹æ‰‹',
                playerAvatar: '',
                opponentAvatar: ''
            };
        }

        // é‡æ–°å¼€å§‹
        restartButton.addEventListener('click', () => {
            clearInterval(gameState.timer);
            initializeGame();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.gameOver = false;
            gameState.timeLeft = gameState.timeLimit;
            gameState.lastMove = null;

            // æ›´æ–°ç©å®¶ä¿¡æ¯æ˜¾ç¤º
            blackNameElement.textContent = gameState.player1Name;
            whiteNameElement.textContent = gameState.player2Name;
            blackAvatarElement.textContent = gameState.player1Avatar;
            whiteAvatarElement.textContent = gameState.mode === 'pvp' ? gameState.player2Avatar : gameState.computerAvatar;

            // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
            updatePlayerIndicator();

            // æ¸…ç©ºæ¶ˆæ¯
            showMessage('');

            // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
            timerElement.textContent = gameState.timeLeft;

            // åˆ›å»ºæ£‹ç›˜
            boardElement.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    boardElement.appendChild(cell);
                }
            }

            // å¼€å§‹è®¡æ—¶
            startTimer();

            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”ç”µè„‘å…ˆæ‰‹ï¼Œåˆ™ç”µè„‘è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white') {
                setTimeout(computerMove, 500);
            }

            // åˆå§‹åŒ–æ‚”æ£‹ç›¸å…³çŠ¶æ€
            gameState.moveHistory = [];
            updateUndoButton();
        }

        // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
        function updatePlayerIndicator() {
            if (gameState.currentPlayer === 'black') {
                blackPlayerInfo.classList.add('active');
                whitePlayerInfo.classList.remove('active');
            } else {
                blackPlayerInfo.classList.remove('active');
                whitePlayerInfo.classList.add('active');
            }
        }

        // å¤„ç†ç‚¹å‡»æ ¼å­
        function handleCellClick(row, col) {
            if (gameState.gameOver) {
                showMessage('æ¸¸æˆå·²ç»“æŸï¼Œè¯·é‡æ–°å¼€å§‹æˆ–è¿”å›èœå•');
                return;
            }

            // åœ¨çº¿æ¨¡å¼ä¸‹çš„å›åˆæ§åˆ¶
            if (gameState.mode === 'online') {
                const isMyTurn = (gameState.currentPlayer === 'black' && gameState.online.isHost) ||
                    (gameState.currentPlayer === 'white' && !gameState.online.isHost);
                if (!isMyTurn) {
                    showMessage('è¯·ç­‰å¾…å¯¹æ‰‹è½å­');
                    return;
                }
            }

            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”å½“å‰æ˜¯ç”µè„‘å›åˆï¼Œåˆ™ä¸å…è®¸è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white') return;

            // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦å·²æœ‰æ£‹å­
            if (gameState.board[row][col]) return;

            // è½å­
            placeStone(row, col, gameState.currentPlayer);

            // åœ¨çº¿æ¨¡å¼ä¸‹å‘é€è½å­æ•°æ®
            if (gameState.mode === 'online' && gameState.online.conn) {
                gameState.online.conn.send({
                    type: 'move',
                    row: row,
                    col: col,
                    player: gameState.currentPlayer
                });
            }

            // æ£€æŸ¥æ˜¯å¦è·èƒœ
            if (checkWin(row, col, gameState.currentPlayer)) {
                const winnerName = gameState.currentPlayer === 'black' ? gameState.player1Name : gameState.player2Name;
                
                // åœ¨çº¿æ¨¡å¼ä¸‹å‘é€è·èƒœæ¶ˆæ¯
                if (gameState.mode === 'online' && gameState.online.conn) {
                    gameState.online.conn.send({
                        type: 'game_over',
                        winner: gameState.currentPlayer,
                        winnerName: winnerName
                    });
                }
                
                gameOver(`${winnerName} è·èƒœ!`);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å¹³å±€
            if (checkDraw()) {
                // åœ¨çº¿æ¨¡å¼ä¸‹å‘é€å¹³å±€æ¶ˆæ¯
                if (gameState.mode === 'online' && gameState.online.conn) {
                    gameState.online.conn.send({
                        type: 'game_over',
                        result: 'draw'
                    });
                }
                
                gameOver('å¹³å±€!');
                return;
            }

            // åˆ‡æ¢ç©å®¶
            switchPlayer();

            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”è½®åˆ°ç”µè„‘ï¼Œåˆ™ç”µè„‘è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white' && !gameState.gameOver) {
                setTimeout(computerMove, 500);
            }
        }

        // æ”¾ç½®æ£‹å­
        function placeStone(row, col, player) {
            gameState.board[row][col] = player;
            gameState.lastMove = { row, col };
            
            // è®°å½•ç§»åŠ¨å†å²
            gameState.moveHistory.push({
                row: row,
                col: col,
                player: player
            });

            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            const stone = document.createElement('div');
            stone.className = `stone ${player}`;
            cell.appendChild(stone);

            // é‡ç½®è®¡æ—¶å™¨
            resetTimer();
            
            // æ›´æ–°æ‚”æ£‹æŒ‰é’®çŠ¶æ€
            updateUndoButton();
        }

        // åˆ‡æ¢ç©å®¶
        function switchPlayer() {
            gameState.currentPlayer = gameState.currentPlayer === 'black' ? 'white' : 'black';
            updatePlayerIndicator();
            resetTimer();
        }

        // æ£€æŸ¥æ˜¯å¦è·èƒœ
        function checkWin(row, col, player) {
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],    // å‚ç›´
                [1, 1],    // å¯¹è§’çº¿
                [1, -1]    // åå¯¹è§’çº¿
            ];

            for (const [dx, dy] of directions) {
                let count = 1;

                // æ­£å‘æ£€æŸ¥
                for (let i = 1; i <= 4; i++) {
                    const newRow = row + i * dx;
                    const newCol = col + i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 ||
                        gameState.board[newRow][newCol] !== player) {
                        break;
                    }
                    count++;
                }

                // åå‘æ£€æŸ¥
                for (let i = 1; i <= 4; i++) {
                    const newRow = row - i * dx;
                    const newCol = col - i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 ||
                        gameState.board[newRow][newCol] !== player) {
                        break;
                    }
                    count++;
                }

                if (count >= 5) return true;
            }

            return false;
        }

        // æ£€æŸ¥æ˜¯å¦å¹³å±€
        function checkDraw() {
            return gameState.board.every(row => row.every(cell => cell !== null));
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(message) {
            gameState.gameOver = true;
            clearInterval(gameState.timer);
            showMessage(message, 'winner');

            // ç§»é™¤å½“å‰ç©å®¶æŒ‡ç¤º
            blackPlayerInfo.classList.remove('active');
            whitePlayerInfo.classList.remove('active');

            // æ·»åŠ æ¸¸æˆç»“æŸçš„è§†è§‰æ•ˆæœ
            const board = document.getElementById('board');
            board.style.opacity = '0.8';
            board.style.pointerEvents = 'none';

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸé€‰é¡¹
            const sidebar = document.querySelector('.game-sidebar');
            if (sidebar) {
                if (gameState.mode === 'online') {
                    sidebar.innerHTML = `
                        <button class="sidebar-button rematch" onclick="handleRematch()" id="rematch-button">
                            <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                        </button>
                        <button class="sidebar-button menu" onclick="handleReturnToMenu()" id="menu-button">
                            <i class="fas fa-home"></i> è¿”å›èœå•
                        </button>
                    `;
                } else {
                    sidebar.innerHTML = `
                        <button class="sidebar-button rematch" onclick="handleRematch()" id="rematch-button">
                            <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                        </button>
                        <button class="sidebar-button menu" onclick="handleReturnToMenu()" id="menu-button">
                            <i class="fas fa-home"></i> è¿”å›èœå•
                        </button>
                    `;
                }
            }
        }

        // ç»Ÿä¸€å¤„ç†é‡æ–°å¼€å§‹
        function handleRematch() {
            if (gameState.mode === 'online') {
                if (!gameState.online.conn || !gameState.online.conn.open) {
                    showMessage('è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•è¯·æ±‚é‡æ–°å¼€å§‹');
                    return;
                }

                try {
                    gameState.online.conn.send({
                        type: 'rematch_request'
                    });
                    const rematchBtn = document.getElementById('rematch-button');
                    if (rematchBtn) {
                        rematchBtn.disabled = true;
                        rematchBtn.classList.add('waiting');
                    }
                    showMessage('å·²å‘é€é‡æ–°å¼€å§‹è¯·æ±‚ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤...');
                } catch (error) {
                    console.error('å‘é€é‡æ–°å¼€å§‹è¯·æ±‚å¤±è´¥:', error);
                    showMessage('å‘é€é‡æ–°å¼€å§‹è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
                    const rematchBtn = document.getElementById('rematch-button');
                    if (rematchBtn) {
                        rematchBtn.disabled = false;
                        rematchBtn.classList.remove('waiting');
                    }
                }
            } else {
                startNewGame();
            }
        }

        // å¤„ç†é‡æ–°å¼€å§‹è¯·æ±‚
        function handleRematchRequest() {
            if (confirm('å¯¹æ–¹è¯·æ±‚é‡æ–°å¼€å§‹æ¸¸æˆï¼Œæ˜¯å¦åŒæ„ï¼Ÿ')) {
                try {
                    gameState.online.conn.send({
                        type: 'rematch_accept'
                    });
                    startNewGame();
                } catch (error) {
                    console.error('å‘é€æ¥å—é‡æ–°å¼€å§‹è¯·æ±‚å¤±è´¥:', error);
                    showMessage('å‘é€å“åº”å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                try {
                    gameState.online.conn.send({
                        type: 'rematch_decline'
                    });
                } catch (error) {
                    console.error('å‘é€æ‹’ç»é‡æ–°å¼€å§‹è¯·æ±‚å¤±è´¥:', error);
                }
            }
        }

        // å¼€å§‹æ–°æ¸¸æˆ
        function startNewGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.gameOver = false;
            gameState.lastMove = null;
            gameState.timeLeft = gameState.timeLimit;
            gameState.moveHistory = [];

            // é‡ç½®æ£‹ç›˜UI
            const board = document.getElementById('board');
            board.style.opacity = '1';
            board.style.pointerEvents = 'auto';
            
            // æ¸…ç©ºæ‰€æœ‰æ£‹å­
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                while (cell.firstChild) {
                    cell.removeChild(cell.firstChild);
                }
            });

            // é‡ç½®æ¶ˆæ¯
            showMessage('');

            // å¼€å§‹æ–°çš„è®¡æ—¶
            startTimer();

            // æ›´æ–°ç©å®¶æŒ‡ç¤º
            updatePlayerIndicator();

            // é‡ç½®æ§åˆ¶æŒ‰é’®
            const sidebar = document.querySelector('.game-sidebar');
            if (sidebar) {
                sidebar.innerHTML = `
                    <button class="sidebar-button undo" onclick="handleUndo()" id="undo-button">
                        <i class="fas fa-undo"></i> æ‚”æ£‹
                    </button>
                    <button class="sidebar-button rematch" onclick="handleRematch()" id="rematch-button">
                        <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                    </button>
                    <button class="sidebar-button menu" onclick="handleReturnToMenu()" id="menu-button">
                        <i class="fas fa-home"></i> è¿”å›èœå•
                    </button>
                `;
            }
        }

        // å¯ç”¨é‡æ–°å¼€å§‹æŒ‰é’®
        function enableRematchButton() {
            const rematchBtn = document.querySelector('.rematch-btn');
            if (rematchBtn) {
                rematchBtn.disabled = false;
                rematchBtn.classList.remove('waiting');
            }
        }

        // ç”µè„‘èµ°æ£‹
        function computerMove() {
            if (gameState.gameOver) return;

            let move;
            switch (gameState.difficulty) {
                case 'easy':
                    move = getRandomMove();
                    break;
                case 'medium':
                    move = getMediumMove();
                    break;
                case 'hard':
                    move = getBestMove();
                    break;
                default:
                    move = getMediumMove();
            }

            if (move) {
                placeStone(move.row, move.col, 'white');

                // æ£€æŸ¥æ˜¯å¦è·èƒœ
                if (checkWin(move.row, move.col, 'white')) {
                    gameOver(`${gameState.player2Name} è·èƒœ!`);
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å¹³å±€
                if (checkDraw()) {
                    gameOver('å¹³å±€!');
                    return;
                }

                switchPlayer();
            }
        }

        // ç®€å•éš¾åº¦ - éšæœºèµ°æ£‹
        function getRandomMove() {
            const emptyCells = [];
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        emptyCells.push({ row: i, col: j });
                    }
                }
            }

            return emptyCells.length > 0 ? emptyCells[Math.floor(Math.random() * emptyCells.length)] : null;
        }

        // ä¸­ç­‰éš¾åº¦ - æœ‰ä¸€å®šç­–ç•¥
        function getMediumMove() {
            // å¦‚æœæœ‰å¯ä»¥ç«‹å³è·èƒœçš„ä½ç½®ï¼Œé€‰æ‹©å®ƒ
            const winningMove = findWinningMove('white');
            if (winningMove) return winningMove;

            // å¦‚æœç©å®¶ä¸‹ä¸€æ­¥å¯ä»¥è·èƒœï¼Œé˜»æ­¢ç©å®¶
            const blockingMove = findWinningMove('black');
            if (blockingMove) return blockingMove;

            // å¦åˆ™é€‰æ‹©é è¿‘å·²æœ‰æ£‹å­çš„ä½ç½®
            return getSmartRandomMove();
        }

        // å›°éš¾éš¾åº¦ - ä½¿ç”¨è¯„ä¼°å‡½æ•°é€‰æ‹©æœ€ä½³èµ°æ³•
        function getBestMove() {
            // å¦‚æœæœ‰å¯ä»¥ç«‹å³è·èƒœçš„ä½ç½®ï¼Œé€‰æ‹©å®ƒ
            const winningMove = findWinningMove('white');
            if (winningMove) return winningMove;

            // å¦‚æœç©å®¶ä¸‹ä¸€æ­¥å¯ä»¥è·èƒœï¼Œé˜»æ­¢ç©å®¶
            const blockingMove = findWinningMove('black');
            if (blockingMove) return blockingMove;

            // ä½¿ç”¨è¯„ä¼°å‡½æ•°é€‰æ‹©æœ€ä½³ä½ç½®
            return evaluateBestMove();
        }

        // å¯»æ‰¾å¯ä»¥ç«‹å³è·èƒœçš„èµ°æ³•
        function findWinningMove(player) {
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        // æ¨¡æ‹Ÿåœ¨è¿™ä¸ªä½ç½®è½å­
                        gameState.board[i][j] = player;
                        if (checkWin(i, j, player)) {
                            // æ’¤é”€æ¨¡æ‹Ÿ
                            gameState.board[i][j] = null;
                            return { row: i, col: j };
                        }
                        // æ’¤é”€æ¨¡æ‹Ÿ
                        gameState.board[i][j] = null;
                    }
                }
            }
            return null;
        }

        // æ™ºèƒ½éšæœºèµ°æ³• - é€‰æ‹©é è¿‘å·²æœ‰æ£‹å­çš„ä½ç½®
        function getSmartRandomMove() {
            const emptyCells = [];
            const priorityCells = [];

            // æ”¶é›†æ‰€æœ‰ç©ºä½
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        emptyCells.push({ row: i, col: j });

                        // æ£€æŸ¥å‘¨å›´æ˜¯å¦æœ‰æ£‹å­
                        if (hasAdjacentStones(i, j)) {
                            priorityCells.push({ row: i, col: j });
                        }
                    }
                }
            }

            // ä¼˜å…ˆé€‰æ‹©å‘¨å›´æœ‰æ£‹å­çš„ä½ç½®
            if (priorityCells.length > 0) {
                return priorityCells[Math.floor(Math.random() * priorityCells.length)];
            }

            // å¦‚æœæ²¡æœ‰å‘¨å›´æœ‰æ£‹å­çš„ä½ç½®ï¼Œéšæœºé€‰æ‹©
            return emptyCells.length > 0 ? emptyCells[Math.floor(Math.random() * emptyCells.length)] : null;
        }

        // æ£€æŸ¥ä½ç½®å‘¨å›´æ˜¯å¦æœ‰æ£‹å­
        function hasAdjacentStones(row, col) {
            for (let i = Math.max(0, row - 1); i <= Math.min(14, row + 1); i++) {
                for (let j = Math.max(0, col - 1); j <= Math.min(14, col + 1); j++) {
                    if ((i !== row || j !== col) && gameState.board[i][j]) {
                        return true;
                    }
                }
            }
            return false;
        }

        // è¯„ä¼°æœ€ä½³èµ°æ³•
        function evaluateBestMove() {
            let bestScore = -Infinity;
            let bestMoves = [];

            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        // è¯„ä¼°è¿™ä¸ªä½ç½®å¯¹ç”µè„‘çš„ä»·å€¼
                        const score = evaluatePosition(i, j, 'white');

                        if (score > bestScore) {
                            bestScore = score;
                            bestMoves = [{ row: i, col: j }];
                        } else if (score === bestScore) {
                            bestMoves.push({ row: i, col: j });
                        }
                    }
                }
            }

            // å¦‚æœæœ‰å¤šä¸ªæœ€ä½³ä½ç½®ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
            return bestMoves.length > 0 ? bestMoves[Math.floor(Math.random() * bestMoves.length)] : null;
        }

        // è¯„ä¼°ä½ç½®çš„ä»·å€¼
        function evaluatePosition(row, col, player) {
            let score = 0;
            const opponent = player === 'black' ? 'white' : 'black';

            // å››ä¸ªæ–¹å‘è¯„ä¼°
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],    // å‚ç›´
                [1, 1],    // å¯¹è§’çº¿
                [1, -1]    // åå¯¹è§’çº¿
            ];

            for (const [dx, dy] of directions) {
                // è¯„ä¼°ç©å®¶åœ¨è¿™ä¸ªæ–¹å‘çš„æ½œåŠ›
                score += evaluateDirection(row, col, dx, dy, player);

                // è¯„ä¼°å¯¹æ‰‹åœ¨è¿™ä¸ªæ–¹å‘çš„å¨èƒ
                score += evaluateDirection(row, col, dx, dy, opponent) * 0.8;
            }

            // ä¸­å¿ƒä½ç½®æ›´æœ‰ä»·å€¼
            const centerDist = Math.sqrt(Math.pow(row - 7, 2) + Math.pow(col - 7, 2));
            score += (14 - centerDist) * 0.1;

            return score;
        }

        // è¯„ä¼°ç‰¹å®šæ–¹å‘çš„æ½œåŠ›
        function evaluateDirection(row, col, dx, dy, player) {
            let playerCount = 0; // è¿ç»­æ£‹å­æ•°
            let openEnds = 0;    // å¼€æ”¾ç«¯æ•°
            let tempScore = 0;

            // æ£€æŸ¥æ­£å‘
            let i = 1;
            let open = true;
            while (i <= 4) {
                const newRow = row + i * dx;
                const newCol = col + i * dy;

                if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15) {
                    open = false;
                    break;
                }

                if (gameState.board[newRow][newCol] === player) {
                    playerCount++;
                } else if (gameState.board[newRow][newCol] === null) {
                    openEnds++;
                    break;
                } else {
                    open = false;
                    break;
                }

                i++;
            }

            // æ£€æŸ¥åå‘
            i = 1;
            while (i <= 4) {
                const newRow = row - i * dx;
                const newCol = col - i * dy;

                if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15) {
                    open = false;
                    break;
                }

                if (gameState.board[newRow][newCol] === player) {
                    playerCount++;
                } else if (gameState.board[newRow][newCol] === null) {
                    openEnds++;
                    break;
                } else {
                    open = false;
                    break;
                }

                i++;
            }

            // æ ¹æ®è¿ç»­æ£‹å­å’Œå¼€æ”¾ç«¯è®¡ç®—åˆ†æ•°
            if (playerCount >= 4) tempScore += 10000; // å¯ä»¥è¿äº”
            else if (playerCount === 3 && openEnds >= 1) tempScore += 1000; // æ´»å››
            else if (playerCount === 3) tempScore += 100; // å†²å››
            else if (playerCount === 2 && openEnds >= 1) tempScore += 10; // æ´»ä¸‰
            else if (playerCount === 1 && openEnds >= 1) tempScore += 1; // æ´»äºŒ

            return tempScore;
        }

        // è®¡æ—¶å™¨åŠŸèƒ½
        function startTimer() {
            clearInterval(gameState.timer);
            gameState.timeLeft = gameState.timeLimit;
            timerElement.textContent = gameState.timeLeft;

            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timerElement.textContent = gameState.timeLeft;

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    timeOut();
                }
            }, 1000);
        }
        function updateConnectionStatus() {
            const statusEl = document.querySelector('.connection-status');
            if (!statusEl) return;

            if (gameState.online.conn && gameState.online.conn.open) {
                statusEl.textContent = `å·²è¿æ¥: ${gameState.online.opponentName}`;
                statusEl.classList.add('connected');
            } else {
                statusEl.textContent = 'è¿æ¥æ–­å¼€';
                statusEl.classList.remove('connected');
            }
        }

        function resetTimer() {
            gameState.timeLeft = gameState.timeLimit;
            timerElement.textContent = gameState.timeLeft;
        }

        function timeOut() {
            gameOver(`${gameState.currentPlayer === 'black' ? 'é»‘æ£‹' : 'ç™½æ£‹'}è¶…æ—¶ï¼Œæ¸¸æˆç»“æŸ!`);
        }

        // æ·»åŠ æ‚”æ£‹å¤„ç†å‡½æ•°
        function handleUndo() {
            if (!gameState.canUndo || gameState.gameOver || gameState.moveHistory.length === 0) {
                return;
            }

            if (gameState.mode === 'online') {
                // åœ¨çº¿æ¨¡å¼ä¸‹å‘é€æ‚”æ£‹è¯·æ±‚
                if (gameState.online.conn) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„æœ€åä¸€æ­¥
                    const lastMove = gameState.moveHistory[gameState.moveHistory.length - 1];
                    const isMyMove = (gameState.online.isHost && lastMove.player === 'black') ||
                                   (!gameState.online.isHost && lastMove.player === 'white');
                    
                    if (!isMyMove) {
                        showMessage('åªèƒ½æ‚”è‡ªå·±çš„æœ€åä¸€æ­¥');
                        return;
                    }

                    gameState.online.conn.send({
                        type: 'undo_request'
                    });
                    const undoButton = document.getElementById('undo-button');
                    undoButton.disabled = true;
                    undoButton.classList.add('waiting');
                    showMessage('å·²å‘é€æ‚”æ£‹è¯·æ±‚ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤...');
                }
            } else {
                performUndo();
                if (gameState.mode === 'pvc') {
                    // äººæœºå¯¹æˆ˜æ—¶ï¼ŒåŒæ—¶æ’¤é”€ç”µè„‘çš„ä¸€æ­¥
                    performUndo();
                }
            }
        }

        // æ‰§è¡Œæ‚”æ£‹
        function performUndo() {
            if (gameState.moveHistory.length === 0) return;

            const lastMove = gameState.moveHistory.pop();
            const cell = document.querySelector(`.cell[data-row="${lastMove.row}"][data-col="${lastMove.col}"]`);
            if (cell.firstChild) {
                cell.removeChild(cell.firstChild);
            }
            gameState.board[lastMove.row][lastMove.col] = null;
            
            // åˆ‡æ¢ç©å®¶
            gameState.currentPlayer = gameState.currentPlayer === 'black' ? 'white' : 'black';
            updatePlayerIndicator();
            
            // é‡ç½®è®¡æ—¶å™¨
            resetTimer();
            
            // æ›´æ–°æ‚”æ£‹æŒ‰é’®çŠ¶æ€
            updateUndoButton();
        }

        // æ›´æ–°æ‚”æ£‹æŒ‰é’®çŠ¶æ€
        function updateUndoButton() {
            const undoButton = document.getElementById('undo-button');
            if (!undoButton) return;

            // åœ¨çº¿æ¨¡å¼ä¸‹åªèƒ½æ‚”è‡ªå·±çš„æœ€åä¸€æ­¥
            if (gameState.mode === 'online') {
                const canUndo = gameState.moveHistory.length > 0 && 
                    ((gameState.online.isHost && gameState.currentPlayer === 'white') ||
                    (!gameState.online.isHost && gameState.currentPlayer === 'black'));
                undoButton.disabled = !canUndo;
            } else {
                undoButton.disabled = gameState.moveHistory.length === 0 || gameState.gameOver;
            }
        }

        // å¤„ç†æ‚”æ£‹è¯·æ±‚
        function handleUndoRequest() {
            if (confirm('å¯¹æ–¹è¯·æ±‚æ‚”æ£‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ')) {
                gameState.online.conn.send({
                    type: 'undo_accept'
                });
                performUndo();
            } else {
                gameState.online.conn.send({
                    type: 'undo_decline'
                });
            }
        }

        // å¯ç”¨æ‚”æ£‹æŒ‰é’®
        function enableUndoButton() {
            const undoButton = document.getElementById('undo-button');
            if (undoButton) {
                undoButton.disabled = false;
                undoButton.classList.remove('waiting');
            }
        }

        // å¤„ç†é‡æ–°å¼€å§‹è¯·æ±‚
        function handleRematchRequest() {
            if (confirm('å¯¹æ–¹è¯·æ±‚é‡æ–°å¼€å§‹æ¸¸æˆï¼Œæ˜¯å¦åŒæ„ï¼Ÿ')) {
                gameState.online.conn.send({
                    type: 'rematch_accept'
                });
                startRematch();
            } else {
                gameState.online.conn.send({
                    type: 'rematch_decline'
                });
            }
        }

        // æ·»åŠ è¿”å›èœå•å¤„ç†å‡½æ•°
        function handleReturnToMenu() {
            // å¦‚æœæ˜¯åœ¨çº¿æ¨¡å¼ï¼Œéœ€è¦é€šçŸ¥å¯¹æ–¹å¹¶æ¸…ç†è¿æ¥
            if (gameState.mode === 'online' && gameState.online.conn) {
                try {
                    gameState.online.conn.send({
                        type: 'return_to_menu'
                    });
                    cleanupOnlineConnection();
                } catch (e) {
                    console.error('å‘é€è¿”å›èœå•æ¶ˆæ¯å¤±è´¥:', e);
                }
            }

            // æ¸…ç†æ¸¸æˆçŠ¶æ€
            clearInterval(gameState.timer);
            resetGameState();
            
            // åˆ‡æ¢æ˜¾ç¤º
            menuContainer.style.display = 'block';
            gameContainer.style.display = 'none';
            
            // æ¸…ç†åœ¨çº¿å¯¹æˆ˜ç›¸å…³çš„UIå…ƒç´ 
            const statusEl = document.querySelector('.connection-status');
            const modeTag = document.querySelector('.mode-tag');
            if (statusEl) statusEl.remove();
            if (modeTag) modeTag.remove();

            // é‡ç½®æ‰€æœ‰é€‰é¡¹æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // éšè—åœ¨çº¿å¯¹æˆ˜ç›¸å…³çš„å…ƒç´ 
            const roomIdInput = document.getElementById('room-id-input');
            if (roomIdInput) roomIdInput.style.display = 'none';
            
            const roomStatus = document.getElementById('room-status');
            if (roomStatus) roomStatus.textContent = '';

            // é‡ç½®åˆ›å»ºæˆ¿é—´å’ŒåŠ å…¥æˆ¿é—´æŒ‰é’®
            const createRoomBtn = document.getElementById('create-room-btn');
            const joinRoomBtn = document.getElementById('join-room-btn');
            if (createRoomBtn) createRoomBtn.disabled = false;
            if (joinRoomBtn) joinRoomBtn.disabled = false;
        }
    </script>
</body>

</html>