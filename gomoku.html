<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹æ¸¸æˆ</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --dark-color: #2d3142;
            --light-color: #f5f5f5;
            --board-color: #dcb35c;
            --board-border: #8b4513;
            --black-stone: radial-gradient(circle at 30% 30%, #666, #000);
            --white-stone: radial-gradient(circle at 30% 30%, #fff, #ddd);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--light-color);
            color: var(--dark-color);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: var(--secondary-color);
            margin: 15px 0;
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .menu-container, .game-container {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            width: 100%;
            transition: var(--transition);
        }

        .game-container {
            display: none;
        }

        .menu-title, .settings-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent-color);
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }

        .option-button {
            padding: 12px 20px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background-color: white;
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .option-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .option-button.selected {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
        }

        .start-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .start-button:active {
            transform: translateY(0);
        }

/* åœ¨çº¿å¯¹æˆ˜çŠ¶æ€æç¤º */
.connection-status {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9rem;
}

/* æ¸¸æˆæ¨¡å¼æ ‡ç­¾ */
.mode-tag {
    position: absolute;
    top: 10px;
    left: 10px;
    background: var(--primary-color);
    color: white;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
}

/* è¿æ¥çŠ¶æ€åŠ¨ç”» */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

.connection-status.connected {
    background: #4CAF50;
    animation: pulse 2s infinite;
}

        /* æ£‹ç›˜æ ·å¼ */
        #board {
            background-color: var(--board-color);
            display: grid;
            grid-template-columns: repeat(15, 30px);
            grid-template-rows: repeat(15, 30px);
            gap: 1px;
            padding: 15px;
            border: 3px solid var(--board-border);
            border-radius: 5px;
            box-shadow: var(--shadow);
            margin: 0 auto;
        }

        .cell {
            width: 30px;
            height: 30px;
            background-color: rgba(220, 179, 92, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .cell:hover {
            background-color: rgba(210, 169, 82, 0.9);
            transform: scale(1.05);
        }

        .cell::before, .cell::after {
            content: '';
            position: absolute;
            background-color: #000;
        }

        .cell::before {
            width: 100%;
            height: 1px;
            top: 50%;
            transform: translateY(-50%);
        }

        .cell::after {
            width: 1px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .stone {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            z-index: 1;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            transition: var(--transition);
        }

        .black {
            background: var(--black-stone);
        }

        .white {
            background: var(--white-stone);
        }

        /* æ¸¸æˆä¿¡æ¯åŒºåŸŸ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            border-radius: 25px;
            transition: var(--transition);
        }

        .player-info.active {
            background-color: rgba(79, 195, 247, 0.2);
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .player-info.active .player-avatar {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .player-avatar {
            font-size: 1.8rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 50%;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player-role {
            font-size: 0.9rem;
            color: #666;
        }

        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .timer-label {
            font-size: 0.9rem;
            color: #666;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            min-width: 50px;
            text-align: center;
        }

        /* æ¸¸æˆæ¶ˆæ¯ */
        .game-message {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: 8px;
            transition: var(--transition);
        }

        .game-message.winner {
            background-color: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
            font-size: 1.3rem;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 15px;
        }

        .control-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-button i {
            font-size: 1.2rem;
        }

        .restart-button {
            background: linear-gradient(to right, #ff9800, #f57c00);
            color: white;
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 124, 0, 0.3);
        }

        .back-button {
            background: linear-gradient(to right, #9e9e9e, #757575);
            color: white;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(117, 117, 117, 0.3);
        }

        /* è®¾ç½®è¾“å…¥ */
        .settings-group {
            margin-bottom: 20px;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .input-row label {
            min-width: 120px;
            font-weight: 500;
            color: #555;
        }

        .input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-row input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
        }

        /* å¤´åƒé€‰æ‹© */
        .avatar-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .avatar-option {
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 50%;
            padding: 5px;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            background-color: rgba(79, 195, 247, 0.3);
        }

        .avatar-option.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            #board {
                grid-template-columns: repeat(15, 20px);
                grid-template-rows: repeat(15, 20px);
                padding: 10px;
            }

            .cell {
                width: 20px;
                height: 20px;
            }

            .stone {
                width: 18px;
                height: 18px;
            }

            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .player-info {
                width: 100%;
                justify-content: center;
            }

            .option-group {
                flex-direction: column;
            }

            .option-button {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>äº”å­æ£‹æ¸¸æˆ</h1>
        
        <!-- ä¸»èœå• -->
        <div class="menu-container" id="menu-container">
            <h2 class="menu-title">æ¸¸æˆè®¾ç½®</h2>
            
            <!-- åŸæ¨¡å¼é€‰æ‹©éƒ¨åˆ†ä¿®æ”¹ä¸º -->
<div class="section">
    <h3 class="section-title">æ¸¸æˆæ¨¡å¼</h3>
    <div class="option-group">
        <button class="option-button" data-mode="pvp">åŒäººå¯¹æˆ˜</button>
        <button class="option-button" data-mode="pvc">äººæœºå¯¹æˆ˜</button>
        <button class="option-button" data-mode="online">åœ¨çº¿å¯¹æˆ˜</button>
    </div>
</div>

            
            <div class="section" id="difficulty-section" style="display: none;">
                <h3 class="section-title">ç”µè„‘éš¾åº¦</h3>
                <div class="option-group">
                    <button class="option-button" data-difficulty="easy">ç®€å•</button>
                    <button class="option-button" data-difficulty="medium">ä¸­ç­‰</button>
                    <button class="option-button" data-difficulty="hard">å›°éš¾</button>
                </div>
            </div>

            
            <div class="section">
                <h3 class="section-title">ç©å®¶è®¾ç½®</h3>
                <div class="settings-group">
                    <div class="input-row">
                        <label for="player1-name">ç©å®¶1åç§°:</label>
                        <input type="text" id="player1-name" placeholder="ç©å®¶1" maxlength="10">
                    </div>
                    <div class="input-row">
                        <label>ç©å®¶1å¤´åƒ:</label>
                        <div class="player-avatar" id="player1-avatar-preview">ğŸ±</div>
                    </div>
                    <div class="avatar-selection" id="player1-avatar-options">
                        <div class="avatar-option" data-avatar="ğŸµ">ğŸµ</div>
                        <div class="avatar-option" data-avatar="ğŸ¶">ğŸ¶</div>
                        <div class="avatar-option" data-avatar="ğŸ±">ğŸ±</div>
                        <div class="avatar-option" data-avatar="ğŸ­">ğŸ­</div>
                        <div class="avatar-option" data-avatar="ğŸ¹">ğŸ¹</div>
                        <div class="avatar-option" data-avatar="ğŸ°">ğŸ°</div>
                        <div class="avatar-option" data-avatar="ğŸ¦Š">ğŸ¦Š</div>
                        <div class="avatar-option" data-avatar="ğŸ»">ğŸ»</div>
                        <div class="avatar-option" data-avatar="ğŸ¼">ğŸ¼</div>
                        <div class="avatar-option" data-avatar="ğŸ¨">ğŸ¨</div>
                        <div class="avatar-option" data-avatar="ğŸ¯">ğŸ¯</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                    </div>
                </div>
                
                <div class="settings-group" id="player2-settings">
                    <div class="input-row">
                        <label for="player2-name">ç©å®¶2åç§°:</label>
                        <input type="text" id="player2-name" placeholder="ç©å®¶2" maxlength="10">
                    </div>
                    <div class="input-row">
                        <label>ç©å®¶2å¤´åƒ:</label>
                        <div class="player-avatar" id="player2-avatar-preview">ğŸ¶</div>
                    </div>
                    <div class="avatar-selection" id="player2-avatar-options">
                        <div class="avatar-option" data-avatar="ğŸ®">ğŸ®</div>
                        <div class="avatar-option" data-avatar="ğŸ·">ğŸ·</div>
                        <div class="avatar-option" data-avatar="ğŸ¸">ğŸ¸</div>
                        <div class="avatar-option" data-avatar="ğŸ™">ğŸ™</div>
                        <div class="avatar-option" data-avatar="ğŸ¦„">ğŸ¦„</div>
                        <div class="avatar-option" data-avatar="ğŸ²">ğŸ²</div>
                        <div class="avatar-option" data-avatar="ğŸ´">ğŸ´</div>
                        <div class="avatar-option" data-avatar="ğŸ¦“">ğŸ¦“</div>
                        <div class="avatar-option" data-avatar="ğŸ¦’">ğŸ¦’</div>
                        <div class="avatar-option" data-avatar="ğŸ˜">ğŸ˜</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                        <div class="avatar-option" data-avatar="ğŸ¦">ğŸ¦</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">æ¸¸æˆè®¾ç½®</h3>
                <div class="settings-group">
                    <div class="input-row">
                        <label for="time-limit">è½å­æ—¶é—´é™åˆ¶(ç§’):</label>
                        <input type="number" id="time-limit" min="10" max="300" value="60">
                    </div>
                </div>
            </div>

	    <!-- æ–°å¢åœ¨çº¿å¯¹æˆ˜è®¾ç½®é¢æ¿ï¼ˆåŸéš¾åº¦é€‰æ‹©éƒ¨åˆ†ä¸‹æ–¹ï¼‰ -->
<div class="section" id="online-section" style="display: none;">
    <h3 class="section-title">åœ¨çº¿è®¾ç½®</h3>
    <div class="input-row">
        <label for="player-name">ä½ çš„åç§°:</label>
        <input type="text" id="player-name" placeholder="ç©å®¶æ˜µç§°">
    </div>
    <div class="option-group">
        <button class="option-button" id="create-room-btn">åˆ›å»ºæˆ¿é—´</button>
        <button class="option-button" id="join-room-btn">åŠ å…¥æˆ¿é—´</button>
    </div>
    <div class="input-row" id="room-id-input" style="display: none;">
        <label for="room-id">æˆ¿é—´ID:</label>
        <input type="text" id="room-id" placeholder="è¾“å…¥å¯¹æ–¹æˆ¿é—´ID">
    </div>
    <div id="room-status" class="game-message" style="margin-top: 10px;"></div>
</div>
            
            <button class="start-button" id="start-button">
                <i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ
            </button>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="game-container" id="game-container">
            <div class="game-header">
                <div class="player-info" id="black-player-info">
                    <div class="player-avatar" id="black-avatar"></div>
                    <div>
                        <div class="player-name" id="black-name">ç©å®¶1</div>
                        <div class="player-role">é»‘æ£‹</div>
                    </div>
                </div>
                
                <div class="timer-container">
                    <div class="timer-label">å‰©ä½™æ—¶é—´</div>
                    <div class="timer" id="timer">60</div>
                </div>
                
                <div class="player-info" id="white-player-info">
                    <div class="player-avatar" id="white-avatar"></div>
                    <div>
                        <div class="player-name" id="white-name">ç©å®¶2</div>
                        <div class="player-role">ç™½æ£‹</div>
                    </div>
                </div>
            </div>
            
            <div id="board"></div>
            
            <div class="game-message" id="game-message"></div>
            
            <div class="controls">
                <button class="control-button back-button" id="back-button">
                    <i class="fas fa-arrow-left"></i> è¿”å›èœå•
                </button>
                <button class="control-button restart-button" id="restart-button">
                    <i class="fas fa-redo"></i> é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            mode: null, // 'pvp' | 'pvc' | 'online'
            difficulty: 'medium', // 'easy', 'medium', 'hard'
            timeLimit: 60, // é»˜è®¤60ç§’
            board: Array(15).fill().map(() => Array(15).fill(null)), // 15x15æ£‹ç›˜
            currentPlayer: 'black', // 'black' æˆ– 'white'
            gameOver: false,
            timer: null,
            timeLeft: 60,
            lastMove: null,
            player1Name: 'ç©å®¶1',
            player1Avatar: 'ğŸ±',
            player2Name: 'ç©å®¶2',
            player2Avatar: 'ğŸ¶',
            computerAvatar: 'ğŸ¤–',
	    // +++ æ–°å¢åœ¨çº¿å¯¹æˆ˜å±æ€§   
    online: {
        peer: null,
        conn: null,
        isHost: false,
        roomId: '',
        playerName: '',
        opponentName: 'å¯¹æ‰‹'
    }
        };

        // DOMå…ƒç´ 
        const menuContainer = document.getElementById('menu-container');
        const gameContainer = document.getElementById('game-container');
        const boardElement = document.getElementById('board');
        const timerElement = document.getElementById('timer');
        const gameMessageElement = document.getElementById('game-message');
        const blackPlayerInfo = document.getElementById('black-player-info');
        const whitePlayerInfo = document.getElementById('white-player-info');
        const blackNameElement = document.getElementById('black-name');
        const whiteNameElement = document.getElementById('white-name');
        const blackAvatarElement = document.getElementById('black-avatar');
        const whiteAvatarElement = document.getElementById('white-avatar');
        const difficultySection = document.getElementById('difficulty-section');
        const player2Settings = document.getElementById('player2-settings');
        const timeLimitInput = document.getElementById('time-limit');
        const startButton = document.getElementById('start-button');
        const backButton = document.getElementById('back-button');
        const restartButton = document.getElementById('restart-button');
        
        // ç©å®¶è®¾ç½®å…ƒç´ 
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1AvatarPreview = document.getElementById('player1-avatar-preview');
        const player2AvatarPreview = document.getElementById('player2-avatar-preview');
        const player1AvatarOptions = document.querySelectorAll('#player1-avatar-options .avatar-option');
        const player2AvatarOptions = document.querySelectorAll('#player2-avatar-options .avatar-option');

        // åˆå§‹åŒ–å¤´åƒé€‰æ‹©
        player1AvatarOptions.forEach(option => {
            option.addEventListener('click', () => {
                gameState.player1Avatar = option.dataset.avatar;
                player1AvatarPreview.textContent = gameState.player1Avatar;
                player1AvatarOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        player2AvatarOptions.forEach(option => {
            option.addEventListener('click', () => {
                gameState.player2Avatar = option.dataset.avatar;
                player2AvatarPreview.textContent = gameState.player2Avatar;
                player2AvatarOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        // éšæœºé€‰æ‹©åˆå§‹å¤´åƒ
        function selectRandomAvatar() {
            const randomIndex1 = Math.floor(Math.random() * player1AvatarOptions.length);
            const randomIndex2 = Math.floor(Math.random() * player2AvatarOptions.length);
            
            player1AvatarOptions[randomIndex1].click();
            player2AvatarOptions[randomIndex2].click();
        }

        // æ¨¡å¼é€‰æ‹© - ä¿®æ”¹åçš„ä»£ç 
				document.querySelectorAll('.option-group button[data-mode]').forEach(button => {
				    button.addEventListener('click', function() {
				        // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
				        document.querySelectorAll('.option-group button[data-mode]').forEach(btn => {
				            btn.classList.remove('selected');
				        });
				        
				        // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
				        this.classList.add('selected');
				        gameState.mode = this.dataset.mode;
        
        // æ˜¾ç¤ºå¯¹åº”è®¾ç½®é¢æ¿
        difficultySection.style.display = gameState.mode === 'pvc' ? 'block' : 'none';
        player2Settings.style.display = gameState.mode === 'pvp' ? 'block' : 'none';
        document.getElementById('online-section').style.display = 
            gameState.mode === 'online' ? 'block' : 'none';
				    });
				});

				// éš¾åº¦é€‰æ‹©
				document.querySelectorAll('#difficulty-section .option-button').forEach(button => {
				    button.addEventListener('click', function() {
				        document.querySelectorAll('#difficulty-section .option-button').forEach(btn => {
				            btn.classList.remove('selected');
				        });
				        this.classList.add('selected');
				        gameState.difficulty = this.dataset.difficulty;
				    });
				});

        // +++ æ–°å¢ï¼šPeerJSåœ¨çº¿å¯¹æˆ˜é€»è¾‘
// åˆ›å»ºæˆ¿é—´
document.getElementById('create-room-btn').addEventListener('click', () => {
    gameState.online.playerName = document.getElementById('player-name').value || 'ç©å®¶1';
    gameState.online.isHost = true;
    
    gameState.online.peer = new Peer();
    gameState.online.peer.on('open', (id) => {
        gameState.online.roomId = id;
        document.getElementById('room-status').textContent = `æˆ¿é—´ID: ${id}ï¼Œç­‰å¾…å¯¹æ‰‹åŠ å…¥...`;
        document.getElementById('create-room-btn').disabled = true;
    });
    
    gameState.online.peer.on('connection', (conn) => {
        gameState.online.conn = conn;
        setupConnection();
    });
});

// åŠ å…¥æˆ¿é—´
document.getElementById('join-room-btn').addEventListener('click', () => {
    gameState.online.playerName = document.getElementById('player-name').value || 'ç©å®¶2';
    document.getElementById('room-id-input').style.display = 'block';
    
    const roomId = document.getElementById('room-id').value.trim();
    if (!roomId) return;
    
    gameState.online.peer = new Peer();
    gameState.online.peer.on('open', () => {
        gameState.online.conn = gameState.online.peer.connect(roomId);
        setupConnection();
    });
});

function setupConnection() {
    const conn = gameState.online.conn;
    
    conn.on('open', () => {
        // äº¤æ¢ç©å®¶åç§°
        conn.send({ type: 'handshake', name: gameState.online.playerName });
        
        // æ›´æ–°UI
        document.getElementById('online-section').style.display = 'none';
        document.getElementById('room-status').textContent = '';
        
        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        const statusEl = document.createElement('div');
        statusEl.className = 'connection-status';
        statusEl.textContent = `å·²è¿æ¥: ${gameState.online.opponentName}`;
        document.body.appendChild(statusEl);
        
        // æ˜¾ç¤ºæ¸¸æˆæ¨¡å¼æ ‡ç­¾
        const modeTag = document.createElement('div');
        modeTag.className = 'mode-tag';
        modeTag.textContent = 'åœ¨çº¿å¯¹æˆ˜';
        document.body.appendChild(modeTag);
        
        // åˆå§‹åŒ–æ¸¸æˆ
        initializeGame();
    });
    
    conn.on('data', (data) => {
        if (data.type === 'handshake') {
            gameState.online.opponentName = data.name;
        } else if (data.type === 'move') {
            placeStone(data.row, data.col, data.player);
            switchPlayer();
        }
    });
}



// è®¾ç½®è¿æ¥ç›‘å¬
function setupConnectionListeners() {
  gameState.conn.on('open', () => {
    document.getElementById('room-status').textContent = 'å·²è¿æ¥ï¼æ¸¸æˆå¼€å§‹';
    document.getElementById('room-controls').style.display = 'none';
  });
  
  // æ¥æ”¶å¯¹æ–¹è½å­
  gameState.conn.on('data', (data) => {
    if (data.type === 'move') {
      placeStone(data.row, data.col, data.player);
      switchPlayer(); // åˆ‡æ¢å½“å‰ç©å®¶
    }
  });
  
  gameState.conn.on('close', () => {
    alert('è¿æ¥å·²æ–­å¼€');
  });
}
	    
	// å¼€å§‹æ¸¸æˆ
        startButton.addEventListener('click', () => {
            if (!gameState.mode) {
                showMessage('è¯·é€‰æ‹©æ¸¸æˆæ¨¡å¼');
                return;
            }
            
            // è·å–ç©å®¶åç§°
            gameState.player1Name = player1NameInput.value.trim() || 'ç©å®¶1';
            if (gameState.mode === 'pvp') {
                gameState.player2Name = player2NameInput.value.trim() || 'ç©å®¶2';
            } else {
                gameState.player2Name = 'ç”µè„‘';
            }
            
            // è·å–æ—¶é—´é™åˆ¶
            gameState.timeLimit = parseInt(timeLimitInput.value) || 60;
            if (gameState.timeLimit < 10 || gameState.timeLimit > 300) {
                showMessage('æ—¶é—´é™åˆ¶å¿…é¡»åœ¨10-300ç§’ä¹‹é—´', 'error');
                return;
            }
            
            initializeGame();
            menuContainer.style.display = 'none';
            gameContainer.style.display = 'block';
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            gameMessageElement.textContent = message;
            gameMessageElement.className = 'game-message';
            if (type === 'error') {
                gameMessageElement.style.color = '#d32f2f';
            } else if (type === 'winner') {
                gameMessageElement.classList.add('winner');
            }
        }

        // è¿”å›èœå•
        backButton.addEventListener('click', () => {
            clearInterval(gameState.timer);
            menuContainer.style.display = 'block';
            gameContainer.style.display = 'none';
        });

        // é‡æ–°å¼€å§‹
        restartButton.addEventListener('click', () => {
            clearInterval(gameState.timer);
            initializeGame();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.gameOver = false;
            gameState.timeLeft = gameState.timeLimit;
            gameState.lastMove = null;
            
            // æ›´æ–°ç©å®¶ä¿¡æ¯æ˜¾ç¤º
            blackNameElement.textContent = gameState.player1Name;
            whiteNameElement.textContent = gameState.player2Name;
            blackAvatarElement.textContent = gameState.player1Avatar;
            whiteAvatarElement.textContent = gameState.mode === 'pvp' ? gameState.player2Avatar : gameState.computerAvatar;
            
            // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
            updatePlayerIndicator();
            
            // æ¸…ç©ºæ¶ˆæ¯
            showMessage('');
            
            // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
            timerElement.textContent = gameState.timeLeft;
            
            // åˆ›å»ºæ£‹ç›˜
            boardElement.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    boardElement.appendChild(cell);
                }
// åœ¨çº¿æ¨¡å¼ç‰¹æ®Šå¤„ç†
    if (gameState.mode === 'online') {
        // è®¾ç½®ç©å®¶åç§°æ˜¾ç¤º
        if (gameState.online.isHost) {
            blackNameElement.textContent = gameState.online.playerName;
            whiteNameElement.textContent = gameState.online.opponentName;
        } else {
            blackNameElement.textContent = gameState.online.opponentName;
            whiteNameElement.textContent = gameState.online.playerName;
        }
        
        // ç¦ç”¨ä¸éœ€è¦çš„UI
        document.getElementById('back-button').style.display = 'none';
    }
            }
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
            
            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”ç”µè„‘å…ˆæ‰‹ï¼Œåˆ™ç”µè„‘è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white') {
                setTimeout(computerMove, 500);
            }
        }

        // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
        function updatePlayerIndicator() {
            if (gameState.currentPlayer === 'black') {
                blackPlayerInfo.classList.add('active');
                whitePlayerInfo.classList.remove('active');
            } else {
                blackPlayerInfo.classList.remove('active');
                whitePlayerInfo.classList.add('active');
            }
        }

        // å¤„ç†ç‚¹å‡»æ ¼å­
        function handleCellClick(row, col) {
            if (gameState.gameOver) return;
            // +++ æ–°å¢ï¼šåœ¨çº¿æ¨¡å¼ä¸‹åªèƒ½å½“å‰ç©å®¶æ“ä½œ
		  // åœ¨çº¿æ¨¡å¼ä¸‹çš„å›åˆæ§åˆ¶
    if (gameState.mode === 'online') {
        const isMyTurn = (gameState.currentPlayer === 'black' && gameState.online.isHost) || 
                        (gameState.currentPlayer === 'white' && !gameState.online.isHost);
        if (!isMyTurn) {
            showMessage('è¯·ç­‰å¾…å¯¹æ‰‹è½å­');
            return;
        }
    }
            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”å½“å‰æ˜¯ç”µè„‘å›åˆï¼Œåˆ™ä¸å…è®¸è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white') return;
            
            // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦å·²æœ‰æ£‹å­
            if (gameState.board[row][col]) return;
            
            // è½å­
            placeStone(row, col, gameState.currentPlayer);

		// +++ æ–°å¢ï¼šåœ¨çº¿æ¨¡å¼ä¸‹å‘é€è½å­ä¿¡æ¯
		  // åœ¨çº¿æ¨¡å¼ä¸‹å‘é€è½å­æ•°æ®
    if (gameState.mode === 'online' && gameState.online.conn) {
        gameState.online.conn.send({
            type: 'move',
            row: row,
            col: col,
            player: gameState.currentPlayer
        });
    }
            
            // æ£€æŸ¥æ˜¯å¦è·èƒœ
            if (checkWin(row, col, gameState.currentPlayer)) {
                const winnerName = gameState.currentPlayer === 'black' ? gameState.player1Name : gameState.player2Name;
                gameOver(`${winnerName} è·èƒœ!`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å¹³å±€
            if (checkDraw()) {
                gameOver('å¹³å±€!');
                return;
            }
            
            // åˆ‡æ¢ç©å®¶
            switchPlayer();
            
            // å¦‚æœæ˜¯äººæœºå¯¹æˆ˜ä¸”è½®åˆ°ç”µè„‘ï¼Œåˆ™ç”µè„‘è½å­
            if (gameState.mode === 'pvc' && gameState.currentPlayer === 'white' && !gameState.gameOver) {
                setTimeout(computerMove, 500);
            }
        }

        // æ”¾ç½®æ£‹å­
        function placeStone(row, col, player) {
            gameState.board[row][col] = player;
            gameState.lastMove = { row, col };
            
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            const stone = document.createElement('div');
            stone.className = `stone ${player}`;
            cell.appendChild(stone);
            
            // é‡ç½®è®¡æ—¶å™¨
            resetTimer();
        }

        // åˆ‡æ¢ç©å®¶
        function switchPlayer() {
            gameState.currentPlayer = gameState.currentPlayer === 'black' ? 'white' : 'black';
            updatePlayerIndicator();
            resetTimer();
        }

        // æ£€æŸ¥æ˜¯å¦è·èƒœ
        function checkWin(row, col, player) {
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],    // å‚ç›´
                [1, 1],    // å¯¹è§’çº¿
                [1, -1]    // åå¯¹è§’çº¿
            ];
            
            for (const [dx, dy] of directions) {
                let count = 1;
                
                // æ­£å‘æ£€æŸ¥
                for (let i = 1; i <= 4; i++) {
                    const newRow = row + i * dx;
                    const newCol = col + i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 || 
                        gameState.board[newRow][newCol] !== player) {
                        break;
                    }
                    count++;
                }
                
                // åå‘æ£€æŸ¥
                for (let i = 1; i <= 4; i++) {
                    const newRow = row - i * dx;
                    const newCol = col - i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 || 
                        gameState.board[newRow][newCol] !== player) {
                        break;
                    }
                    count++;
                }
                
                if (count >= 5) return true;
            }
            
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦å¹³å±€
        function checkDraw() {
            return gameState.board.every(row => row.every(cell => cell !== null));
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(message) {
            gameState.gameOver = true;
            clearInterval(gameState.timer);
            showMessage(message, 'winner');
            
            // ç§»é™¤å½“å‰ç©å®¶æŒ‡ç¤º
            blackPlayerInfo.classList.remove('active');
            whitePlayerInfo.classList.remove('active');
        }

        // ç”µè„‘èµ°æ£‹
        function computerMove() {
            if (gameState.gameOver) return;
            
            let move;
            switch (gameState.difficulty) {
                case 'easy':
                    move = getRandomMove();
                    break;
                case 'medium':
                    move = getMediumMove();
                    break;
                case 'hard':
                    move = getBestMove();
                    break;
                default:
                    move = getMediumMove();
            }
            
            if (move) {
                placeStone(move.row, move.col, 'white');
                
                // æ£€æŸ¥æ˜¯å¦è·èƒœ
                if (checkWin(move.row, move.col, 'white')) {
                    gameOver(`${gameState.player2Name} è·èƒœ!`);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å¹³å±€
                if (checkDraw()) {
                    gameOver('å¹³å±€!');
                    return;
                }
                
                switchPlayer();
            }
        }

        // ç®€å•éš¾åº¦ - éšæœºèµ°æ£‹
        function getRandomMove() {
            const emptyCells = [];
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        emptyCells.push({ row: i, col: j });
                    }
                }
            }
            
            return emptyCells.length > 0 ? emptyCells[Math.floor(Math.random() * emptyCells.length)] : null;
        }

        // ä¸­ç­‰éš¾åº¦ - æœ‰ä¸€å®šç­–ç•¥
        function getMediumMove() {
            // å¦‚æœæœ‰å¯ä»¥ç«‹å³è·èƒœçš„ä½ç½®ï¼Œé€‰æ‹©å®ƒ
            const winningMove = findWinningMove('white');
            if (winningMove) return winningMove;
            
            // å¦‚æœç©å®¶ä¸‹ä¸€æ­¥å¯ä»¥è·èƒœï¼Œé˜»æ­¢ç©å®¶
            const blockingMove = findWinningMove('black');
            if (blockingMove) return blockingMove;
            
            // å¦åˆ™é€‰æ‹©é è¿‘å·²æœ‰æ£‹å­çš„ä½ç½®
            return getSmartRandomMove();
        }

        // å›°éš¾éš¾åº¦ - ä½¿ç”¨è¯„ä¼°å‡½æ•°é€‰æ‹©æœ€ä½³èµ°æ³•
        function getBestMove() {
            // å¦‚æœæœ‰å¯ä»¥ç«‹å³è·èƒœçš„ä½ç½®ï¼Œé€‰æ‹©å®ƒ
            const winningMove = findWinningMove('white');
            if (winningMove) return winningMove;
            
            // å¦‚æœç©å®¶ä¸‹ä¸€æ­¥å¯ä»¥è·èƒœï¼Œé˜»æ­¢ç©å®¶
            const blockingMove = findWinningMove('black');
            if (blockingMove) return blockingMove;
            
            // ä½¿ç”¨è¯„ä¼°å‡½æ•°é€‰æ‹©æœ€ä½³ä½ç½®
            return evaluateBestMove();
        }

        // å¯»æ‰¾å¯ä»¥ç«‹å³è·èƒœçš„èµ°æ³•
        function findWinningMove(player) {
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        // æ¨¡æ‹Ÿåœ¨è¿™ä¸ªä½ç½®è½å­
                        gameState.board[i][j] = player;
                        if (checkWin(i, j, player)) {
                            // æ’¤é”€æ¨¡æ‹Ÿ
                            gameState.board[i][j] = null;
                            return { row: i, col: j };
                        }
                        // æ’¤é”€æ¨¡æ‹Ÿ
                        gameState.board[i][j] = null;
                    }
                }
            }
            return null;
        }

        // æ™ºèƒ½éšæœºèµ°æ³• - é€‰æ‹©é è¿‘å·²æœ‰æ£‹å­çš„ä½ç½®
        function getSmartRandomMove() {
            const emptyCells = [];
            const priorityCells = [];
            
            // æ”¶é›†æ‰€æœ‰ç©ºä½
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        emptyCells.push({ row: i, col: j });
                        
                        // æ£€æŸ¥å‘¨å›´æ˜¯å¦æœ‰æ£‹å­
                        if (hasAdjacentStones(i, j)) {
                            priorityCells.push({ row: i, col: j });
                        }
                    }
                }
            }
            
            // ä¼˜å…ˆé€‰æ‹©å‘¨å›´æœ‰æ£‹å­çš„ä½ç½®
            if (priorityCells.length > 0) {
                return priorityCells[Math.floor(Math.random() * priorityCells.length)];
            }
            
            // å¦‚æœæ²¡æœ‰å‘¨å›´æœ‰æ£‹å­çš„ä½ç½®ï¼Œéšæœºé€‰æ‹©
            return emptyCells.length > 0 ? emptyCells[Math.floor(Math.random() * emptyCells.length)] : null;
        }

        // æ£€æŸ¥ä½ç½®å‘¨å›´æ˜¯å¦æœ‰æ£‹å­
        function hasAdjacentStones(row, col) {
            for (let i = Math.max(0, row - 1); i <= Math.min(14, row + 1); i++) {
                for (let j = Math.max(0, col - 1); j <= Math.min(14, col + 1); j++) {
                    if ((i !== row || j !== col) && gameState.board[i][j]) {
                        return true;
                    }
                }
            }
            return false;
        }

        // è¯„ä¼°æœ€ä½³èµ°æ³•
        function evaluateBestMove() {
            let bestScore = -Infinity;
            let bestMoves = [];
            
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    if (!gameState.board[i][j]) {
                        // è¯„ä¼°è¿™ä¸ªä½ç½®å¯¹ç”µè„‘çš„ä»·å€¼
                        const score = evaluatePosition(i, j, 'white');
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMoves = [{ row: i, col: j }];
                        } else if (score === bestScore) {
                            bestMoves.push({ row: i, col: j });
                        }
                    }
                }
            }
            
            // å¦‚æœæœ‰å¤šä¸ªæœ€ä½³ä½ç½®ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
            return bestMoves.length > 0 ? bestMoves[Math.floor(Math.random() * bestMoves.length)] : null;
        }

        // è¯„ä¼°ä½ç½®çš„ä»·å€¼
        function evaluatePosition(row, col, player) {
            let score = 0;
            const opponent = player === 'black' ? 'white' : 'black';
            
            // å››ä¸ªæ–¹å‘è¯„ä¼°
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],    // å‚ç›´
                [1, 1],    // å¯¹è§’çº¿
                [1, -1]    // åå¯¹è§’çº¿
            ];
            
            for (const [dx, dy] of directions) {
                // è¯„ä¼°ç©å®¶åœ¨è¿™ä¸ªæ–¹å‘çš„æ½œåŠ›
                score += evaluateDirection(row, col, dx, dy, player);
                
                // è¯„ä¼°å¯¹æ‰‹åœ¨è¿™ä¸ªæ–¹å‘çš„å¨èƒ
                score += evaluateDirection(row, col, dx, dy, opponent) * 0.8;
            }
            
            // ä¸­å¿ƒä½ç½®æ›´æœ‰ä»·å€¼
            const centerDist = Math.sqrt(Math.pow(row - 7, 2) + Math.pow(col - 7, 2));
            score += (14 - centerDist) * 0.1;
            
            return score;
        }

        // è¯„ä¼°ç‰¹å®šæ–¹å‘çš„æ½œåŠ›
        function evaluateDirection(row, col, dx, dy, player) {
            let playerCount = 0; // è¿ç»­æ£‹å­æ•°
            let openEnds = 0;    // å¼€æ”¾ç«¯æ•°
            let tempScore = 0;
            
            // æ£€æŸ¥æ­£å‘
            let i = 1;
            let open = true;
            while (i <= 4) {
                const newRow = row + i * dx;
                const newCol = col + i * dy;
                
                if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15) {
                    open = false;
                    break;
                }
                
                if (gameState.board[newRow][newCol] === player) {
                    playerCount++;
                } else if (gameState.board[newRow][newCol] === null) {
                    openEnds++;
                    break;
                } else {
                    open = false;
                    break;
                }
                
                i++;
            }
            
            // æ£€æŸ¥åå‘
            i = 1;
            while (i <= 4) {
                const newRow = row - i * dx;
                const newCol = col - i * dy;
                
                if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15) {
                    open = false;
                    break;
                }
                
                if (gameState.board[newRow][newCol] === player) {
                    playerCount++;
                } else if (gameState.board[newRow][newCol] === null) {
                    openEnds++;
                    break;
                } else {
                    open = false;
                    break;
                }
                
                i++;
            }
            
            // æ ¹æ®è¿ç»­æ£‹å­å’Œå¼€æ”¾ç«¯è®¡ç®—åˆ†æ•°
            if (playerCount >= 4) tempScore += 10000; // å¯ä»¥è¿äº”
            else if (playerCount === 3 && openEnds >= 1) tempScore += 1000; // æ´»å››
            else if (playerCount === 3) tempScore += 100; // å†²å››
            else if (playerCount === 2 && openEnds >= 1) tempScore += 10; // æ´»ä¸‰
            else if (playerCount === 1 && openEnds >= 1) tempScore += 1; // æ´»äºŒ
            
            return tempScore;
        }

        // è®¡æ—¶å™¨åŠŸèƒ½
        function startTimer() {
            clearInterval(gameState.timer);
            gameState.timeLeft = gameState.timeLimit;
            timerElement.textContent = gameState.timeLeft;
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timerElement.textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    timeOut();
                }
            }, 1000);
        }
function updateConnectionStatus() {
    const statusEl = document.querySelector('.connection-status');
    if (!statusEl) return;
    
    if (gameState.online.conn && gameState.online.conn.open) {
        statusEl.textContent = `å·²è¿æ¥: ${gameState.online.opponentName}`;
        statusEl.classList.add('connected');
    } else {
        statusEl.textContent = 'è¿æ¥æ–­å¼€';
        statusEl.classList.remove('connected');
    }
}

        function resetTimer() {
            gameState.timeLeft = gameState.timeLimit;
            timerElement.textContent = gameState.timeLeft;
        }

        function timeOut() {
            gameOver(`${gameState.currentPlayer === 'black' ? 'é»‘æ£‹' : 'ç™½æ£‹'}è¶…æ—¶ï¼Œæ¸¸æˆç»“æŸ!`);
        }
    </script>
</body>
</html>
